<!-- A summary of all changes -->
<div class="motion-detail-diff">
    @if (showSummary) {
        <os-motion-detail-diff-summary
            [motion]="motion"
            [changes]="changes"
            [scrollToChange]="scrollToChange"
            [elContainer]="nativeElement"
        ></os-motion-detail-diff-summary>
    }
    @if (showPreamble) {
        <span class="text-prefix-label">{{ preamble }}</span>
    }

    <!-- The actual diff view -->
    <div class="motion-text-with-diffs underlined-links">
        @if (getTitleChangingObject(); as changedTitle) {
            <div>
                <div class="diff-box diff-box-{{ changedTitle.getChangeId() }} clearfix outlined-hover outlined-border">
                    <div class="action-row" *osPerms="permission.motionCanManage">
                        @if (isRecommendation(changedTitle)) {
                            <button
                                mat-icon-button
                                type="button"
                                [matMenuTriggerFor]="changeRecommendationMenu"
                                [matMenuTriggerData]="{ change: changedTitle }"
                            >
                                <mat-icon>more_horiz</mat-icon>
                            </button>
                        }
                    </div>
                    @if (changedTitle.isRejected()) {
                        <div class="status-row">
                            <i class="grey">{{ 'Rejected' | translate }}</i>
                        </div>
                    }
                    <div
                        class="motion-text motion-text-diff"
                        [class.line-numbers-none]="isLineNumberingNone()"
                        [class.line-numbers-inline]="isLineNumberingInline()"
                        [class.line-numbers-outside]="isLineNumberingOutside()"
                        [attr.data-change-id]="changedTitle.getChangeId()"
                    >
                        <div class="bold">{{ 'Changed title' | translate }}:</div>
                        <div [innerHTML]="getFormattedTitleDiff() | trust: 'html'"></div>
                    </div>
                </div>
            </div>
        }
        @for (change of getAllTextChangingObjects(); track change; let i = $index) {
            <div>
                <div
                    class="motion-text"
                    [class.line-numbers-none]="isLineNumberingNone()"
                    [class.line-numbers-inline]="isLineNumberingInline()"
                    [class.line-numbers-outside]="isLineNumberingOutside()"
                >
                    <os-motion-detail-original-change-recommendations
                        [html]="getTextBetweenChanges(getAllTextChangingObjects()[i - 1], change)"
                        [motionId]="motion.id"
                        [changeRecommendations]="[]"
                        (createChangeRecommendation)="onCreateChangeRecommendation($event)"
                    ></os-motion-detail-original-change-recommendations>
                </div>
                <div
                    class="diff-box diff-box-{{ change.getChangeId() }} clearfix outlined-hover outlined-border"
                    [class.collides]="hasCollissions(change, getAllTextChangingObjects())"
                >
                    @if (hasCollissions(change, getAllTextChangingObjects())) {
                        <div class="collission-hint">
                            <mat-icon matTooltip="{{ 'This change collides with another one.' | translate }}">
                                warning
                            </mat-icon>
                        </div>
                    }
                    <div class="action-row">
                        <button
                            mat-icon-button
                            *osPerms="permission.motionCanManage; and: isRecommendation(change)"
                            type="button"
                            [matMenuTriggerFor]="changeRecommendationMenu"
                            [matMenuTriggerData]="{ change: change }"
                        >
                            <mat-icon>more_horiz</mat-icon>
                        </button>
                        @if (isAmendment(change)) {
                            <button
                                mat-icon-button
                                type="button"
                                [matMenuTriggerFor]="amendmentMenu"
                                [matMenuTriggerData]="{ change: change }"
                            >
                                <mat-icon>more_horiz</mat-icon>
                            </button>
                        }
                    </div>
                    @if (isChangeRecommendation(change) && change.isRejected()) {
                        <div class="status-row">
                            <i class="grey">{{ 'Rejected' | translate }}</i>
                        </div>
                    }
                    <!-- If it's an amendment, only accepted ones will be passed to this component
          by default (== !showAllAmendments). In this case, don't show the prefix.
          However, if showAllAmendments === true, the prefix should be shown alwayes,
          even if it's accepted -->
                    @if (isAmendment(change) && showAllAmendments) {
                        <div class="status-row">
                            <i class="grey">{{ change.amendment.number }} - {{ change.amendment.state!.name }}</i>
                        </div>
                    }
                    <div
                        class="motion-text motion-text-diff"
                        [class.line-numbers-none]="isLineNumberingNone()"
                        [class.line-numbers-inline]="isLineNumberingInline()"
                        [class.line-numbers-outside]="isLineNumberingOutside()"
                        [attr.data-change-id]="change.getChangeId()"
                        [innerHTML]="getDiff(change) | trust: 'html'"
                    ></div>
                </div>
            </div>
        }

        <div
            class="motion-text"
            [class.line-numbers-none]="isLineNumberingNone()"
            [class.line-numbers-inline]="isLineNumberingInline()"
            [class.line-numbers-outside]="isLineNumberingOutside()"
        >
            <os-motion-detail-original-change-recommendations
                [html]="getTextRemainderAfterLastChange()"
                [motionId]="motion.id"
                [changeRecommendations]="[]"
                (createChangeRecommendation)="onCreateChangeRecommendation($event)"
            ></os-motion-detail-original-change-recommendations>
        </div>
    </div>

    <mat-menu #amendmentMenu="matMenu">
        <ng-template matMenuContent let-change="change">
            <a
                type="button"
                mat-menu-item
                [routerLink]="change.amendment.getDetailStateUrl()"
                [state]="{ back: 'true' }"
            >
                <mat-icon>visibility_on</mat-icon>
                @if (!change?.amendment?.identifier) {
                    <span>{{ 'Show amendment' | translate }}</span>
                }
                @if (change?.amendment?.identifier) {
                    <span>{{ change.amendment.identifier }}</span>
                }
            </a>

            <!-- perms.isAllowed('change_state', motion) (which does not exist)-->
            <ng-container *osPerms="permission.motionCanManage">
                @if (change.amendment.state.next_states.length > 0) {
                    <mat-divider></mat-divider>
                }
                @for (state of change.amendment.state.next_states; track state) {
                    <button mat-menu-item (click)="setAmendmentState(change, state.id)">
                        {{ state.name }}
                        @if (state.show_state_extension_field) {
                            <span>&nbsp;...</span>
                        }
                    </button>
                }
                @if (change.amendment.state.next_states.length > 0) {
                    <mat-divider></mat-divider>
                }
                @for (state of change.amendment.state.previous_states; track state) {
                    <button mat-menu-item (click)="setAmendmentState(change, state.id)">
                        <mat-icon>arrow_back</mat-icon>
                        {{ state.name }}
                        @if (state.show_state_extension_field) {
                            <span>&nbsp;...</span>
                        }
                    </button>
                }
                <button mat-menu-item (click)="resetAmendmentState(change)">
                    <mat-icon>replay</mat-icon>
                    {{ 'Reset state' | translate }}
                </button>
            </ng-container>
        </ng-template>
    </mat-menu>

    <mat-menu #changeRecommendationMenu="matMenu">
        <ng-template matMenuContent let-change="change">
            <button type="button" mat-menu-item (click)="setAcceptanceValue(change, 'accepted')">
                <mat-icon>thumb_up</mat-icon>
                <span>{{ 'Accept' | translate }}</span>
                <mat-icon class="active-indicator">{{ change.isAccepted() ? 'done' : '' }}</mat-icon>
            </button>
            <button type="button" mat-menu-item (click)="setAcceptanceValue(change, 'rejected')">
                <mat-icon>thumb_down</mat-icon>
                <span>{{ 'Reject' | translate }}</span>
                <mat-icon class="active-indicator">{{ change.isRejected() ? 'done' : '' }}</mat-icon>
            </button>
            <button type="button" mat-menu-item (click)="setInternal(change, !change.internal)">
                <mat-icon>{{ change.internal ? 'check_box_outline_blank' : 'check_box' }}</mat-icon>
                <span>{{ 'Public' | translate }}</span>
            </button>
            <button type="button" mat-menu-item (click)="deleteChangeRecommendation(change, $event)">
                <mat-icon>delete</mat-icon>
                <span>{{ 'Delete' | translate }}</span>
            </button>
            @if (!change.isTitleChange()) {
                <button type="button" mat-menu-item (click)="editChangeRecommendation(change, $event)">
                    <mat-icon>edit</mat-icon>
                    <span>{{ 'Edit' | translate }}</span>
                </button>
            }
            @if (change.isTitleChange()) {
                <button type="button" mat-menu-item (click)="editTitleChangeRecommendation(change, $event)">
                    <mat-icon>edit</mat-icon>
                    <span>{{ 'Edit' | translate }}</span>
                </button>
            }
        </ng-template>
    </mat-menu>
</div>
