<ng-container *ngIf="poll && isReady">
    <!-- own voting -->
    <ng-container [ngTemplateOutlet]="votingArea"></ng-container>

    <!-- Delegations -->
    <ng-container *ngIf="isUserPresent && voteDelegationEnabled | async">
        <div class="motion-vote-delegation" *ngFor="let delegation of delegations">
            <mat-divider></mat-divider>

            <ng-container
                [ngTemplateOutlet]="votingArea"
                [ngTemplateOutletContext]="{ delegation: delegation }"
            ></ng-container>
        </div>
        <!-- Submit Votes -->
        <div *ngIf="canSendVotes()">
            <div class="centered-button-wrapper margin-top">
                <button mat-flat-button color="accent" (click)="submitVotes()" [disabled]="compareMinAllVotes()">
                    <mat-icon>how_to_vote</mat-icon>
                    <span>
                        {{ 'Submit all votes now' | translate }}
                    </span>
                </button>
            </div>
        </div>
    </ng-container>
</ng-container>

<ng-template #votingArea let-delegation="delegation">
    <h4 *ngIf="delegation" class="motion-delegation-title">
        <span>{{ 'Voting right for' | translate }}</span>
        <span>&nbsp;{{ delegation.getFullName() }}</span>
    </h4>

    <ng-container *ngIf="{ canVote: canVoteForObservable(delegation) | async } as voting">
        <div *ngIf="voting.canVote">
            <div class="vote-button-grid">
                <!-- Voting -->
                <ng-container *ngFor="let id of poll.option_ids">
                    <div class="vote-button" *ngFor="let option of voteOptions">
                        <button
                            mat-raised-button
                            (click)="saveVote(id, option.vote!, delegation)"
                            [disabled]="isDeliveringVote(delegation)"
                            [ngClass]="getActionButtonClass(option, id, delegation)"
                        >
                            <mat-icon>{{ option.icon }}</mat-icon>
                        </button>
                        <span class="vote-label">{{ option.label | translate }}</span>
                    </div>
                </ng-container>
            </div>
            <!-- Submit Vote -->
            <ng-container
                [ngTemplateOutlet]="sendNow"
                [ngTemplateOutletContext]="{ delegation: delegation }"
            ></ng-container>
        </div>

        <ng-container
            *ngIf="!voting.canVote"
            [ngTemplateOutlet]="cannotVote"
            [ngTemplateOutletContext]="{ delegation: delegation }"
        ></ng-container>

        <!-- Delivering -->
        <div *ngIf="isDeliveringVote(delegation)" class="submit-vote-indicator">
            <mat-spinner class="small-spinner"></mat-spinner>
            <br />
            <span>{{ 'Delivering vote... Please wait!' | translate }}</span>
        </div>
    </ng-container>
</ng-template>

<ng-template #cannotVote let-delegation="delegation">
    <!-- Success -->
    <div *ngIf="hasAlreadyVoted(delegation) && !isDeliveringVote(delegation)" class="user-has-voted">
        <div>
            <mat-icon class="vote-submitted">check_circle</mat-icon>
            <br />
            <span>{{ 'Voting successful.' | translate }}</span>
        </div>
    </div>

    <div *ngIf="hasAlreadyVoted(delegation) === undefined">
        <mat-spinner class="small-spinner"></mat-spinner>
        <br />
        <span>{{ 'Retrieving vote status... Please wait!' | translate }}</span>
    </div>

    <ng-container *ngIf="hasAlreadyVoted(delegation) !== undefined">
        <!-- Error -->
        <div
            *ngIf="
                !hasAlreadyVoted(delegation) && !isDeliveringVote(delegation) && !(!isUserPresent && delegations.length)
            "
        >
            <span>{{ getVotingError(delegation) | translate }}</span>
        </div>
        <div
            *ngIf="
                !hasAlreadyVoted(delegation) && !isDeliveringVote(delegation) && !isUserPresent && delegations.length
            "
        >
            <span>{{ getVotingErrorFromName('USER_NOT_PRESENT') | translate }}</span>
        </div>
    </ng-container>
</ng-template>

<ng-template #sendNow let-delegation="delegation">
    <div class="centered-button-wrapper">
        <button
            mat-flat-button
            color="accent"
            (click)="submitVote(delegation)"
            [disabled]="getVotesCount(delegation) < minVotes"
        >
            <mat-icon>how_to_vote</mat-icon>
            <span>
                {{ 'Submit vote now' | translate }}
            </span>
        </button>
    </div>
</ng-template>
