<os-detail-view [collection]="COLLECTION" (idFound)="onIdFound($event)">
    <os-head-bar
        [hasMainButton]="isAllowed('edit') && !!topic"
        mainButtonIcon="edit"
        [mainActionTooltip]="'Edit' | translate"
        [nav]="false"
        [goBack]="false"
        [prevUrl]="prevUrl"
        [editMode]="editTopic"
        [isSaveButtonEnabled]="topicForm!.valid"
        [saveAction]="getSaveAction()"
        (mainEvent)="setEditMode(!editTopic)"
    >
        <!-- Title -->
        <div class="title-slot">
            <h2>
                @if (newTopic) {
                    <span>{{ 'New topic' | translate }}</span>
                }
                @if (editTopic && !newTopic) {
                    <span>{{ 'Edit topic' | translate }}</span>
                }
                @if (!newTopic && !editTopic && topic) {
                    <span>{{ 'Topic' | translate }}</span>
                }
            </h2>
        </div>

        <!-- Back and forth buttons -->
        @if (!editTopic && showNavigateButtons) {
            <div class="extra-controls-slot">
                <button mat-button (click)="navigateToTopic(previousTopic)" [disabled]="!previousTopic">
                    <os-icon-container icon="chevron_left">
                        {{ getNavDisplay(previousTopic) }}
                    </os-icon-container>
                </button>
                <button mat-button (click)="navigateToTopic(nextTopic)" [disabled]="!nextTopic">
                    <os-icon-container icon="chevron_right" [swap]="true">
                        {{ getNavDisplay(nextTopic) }}
                    </os-icon-container>
                </button>
            </div>
        }

        <!-- Menu -->
        <div
            class="menu-slot"
            *osPerms="[
                permission.agendaItemCanManage,
                permission.listOfSpeakersCanSee,
                permission.listOfSpeakersCanBeSpeaker
            ]"
        >
            @if (topic) {
                <button type="button" mat-icon-button [matMenuTriggerFor]="topicExtraMenu">
                    <mat-icon>more_vert</mat-icon>
                </button>
            }
        </div>
    </os-head-bar>

    @if ((topic || editTopic) && (hasLoaded | async)) {
        <mat-card class="spacer-bottom-60 os-card">
            <mat-card-content>
                @if (!editTopic && topic) {
                    <os-projectable-title [model]="topic" [getTitleFn]="getTitleFn"></os-projectable-title>
                    <div>
                        @if (topic.text) {
                            <span>
                                <!-- Render topic text as HTML -->
                                <div class="detail-view" [innerHTML]="topic.text | trust: 'html'"></div>
                            </span>
                        }
                    </div>
                    @if (topic.hasAttachments()) {
                        <div>
                            <h3>
                                <span>{{ 'Attachments' | translate }}</span>
                                :
                                <mat-list dense>
                                    @for (file of topic.attachments; track file) {
                                        <mat-list-item>
                                            <a [routerLink]="file.url" target="_blank">{{ file.getTitle() }}</a>
                                        </mat-list-item>
                                    }
                                </mat-list>
                            </h3>
                        </div>
                    }
                }
                @if (editTopic && topicForm) {
                    <form [formGroup]="topicForm" (keydown)="onKeyDown($event)" tabindex="-1">
                        <div>
                            <mat-form-field>
                                <mat-label>{{ 'Title' | translate }}</mat-label>
                                <input type="text" matInput osAutofocus required formControlName="title" />
                                @if (topicForm!.invalid) {
                                    <mat-error>{{ 'A name is required' | translate }}</mat-error>
                                }
                            </mat-form-field>
                        </div>
                        <!-- The editor -->
                        <div class="spacer-bottom-20">
                            <h4>{{ 'Text' | translate }}</h4>
                            <os-editor formControlName="text"></os-editor>
                        </div>
                        <!-- Attachments -->
                        <os-attachment-control formControlName="attachment_ids"></os-attachment-control>
                        @if (newTopic) {
                            <div>
                                <!-- Visibility -->
                                <div>
                                    <mat-form-field>
                                        <mat-label>{{ 'Agenda visibility' | translate }}</mat-label>
                                        <mat-select formControlName="agenda_type">
                                            @for (type of itemVisibility; track type) {
                                                <mat-option [value]="type.key">
                                                    <span>{{ type.name | translate }}</span>
                                                </mat-option>
                                            }
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <!-- Parent item -->
                                <div>
                                    <mat-form-field>
                                        <mat-label>{{ 'Parent agenda item' | translate }}</mat-label>
                                        <os-list-search-selector
                                            formControlName="agenda_parent_id"
                                            [includeNone]="true"
                                            [inputListValues]="itemObserver"
                                        ></os-list-search-selector>
                                    </mat-form-field>
                                </div>
                            </div>
                        }
                    </form>
                }
            </mat-card-content>
        </mat-card>
    }
    @if (!editTopic) {
        <os-moderation-note [contentObject]="topic"></os-moderation-note>
    }
    @if (!editTopic) {
        <div class="spacer-bottom-60">
            @if (topic && topic.poll_ids?.length) {
                @for (poll of topic.poll_ids | reverse; track trackById($index, poll)) {
                    <os-topic-poll [pollId]="poll" (dialogOpened)="openDialog(poll)"></os-topic-poll>
                }
            }
            @if (topic && isEVotingEnabled) {
                <div class="create-poll-button">
                    <button
                        *osPerms="[permission.pollCanManage, permission.agendaItemCanManage]"
                        create-poll-button
                        mat-stroked-button
                        (click)="openDialog()"
                    >
                        <mat-icon class="main-nav-color">add</mat-icon>
                        <span>{{ 'New vote' | translate }}</span>
                    </button>
                </div>
            }
        </div>
    }
</os-detail-view>

<mat-menu #topicExtraMenu="matMenu">
    <ng-template matMenuContent>
        <!-- PDF -->
        <button mat-menu-item (click)="onDownloadPdf()">
            <mat-icon>picture_as_pdf</mat-icon>
            <span>{{ 'PDF' | translate }}</span>
        </button>

        <os-projector-button [object]="topic" [menuItem]="true"></os-projector-button>
        <os-speaker-button [object]="topic" [menuItem]="true"></os-speaker-button>
        <div *osPerms="permission.agendaItemCanManage">
            <mat-divider></mat-divider>
            <button mat-menu-item class="red-warning-text" (click)="onDeleteButton()">
                <mat-icon>delete</mat-icon>
                <span>{{ 'Delete' | translate }}</span>
            </button>
        </div>
    </ng-template>
</mat-menu>
