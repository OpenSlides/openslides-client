<mat-card class="os-card" *ngIf="shouldShowPoll">
    <mat-card-content>
        <div class="topic-poll-wrapper">
            <div>
                <!-- Title -->
                <mat-card-title>
                    {{ poll.title }}
                </mat-card-title>

                <!-- Type and State -->
                <div class="type-and-state italic spacer-bottom-20">
                    <ng-container *ngIf="poll.isEVoting">
                        <span *osPerms="permission.agendaItemCanManage; or: poll.isCryptographic">
                            <os-icon-container
                                class="poll-type"
                                icon="info"
                                size="large"
                                color="primary"
                                [swap]="true"
                                [showIcon]="poll.isAnonymous || (poll.isCryptographic && !poll.votes_raw)"
                                (iconAction)="openVotingWarning()"
                            >
                                {{ poll.typeVerbose | translate }}
                            </os-icon-container>
                            <os-icon-container
                                class="poll-type break-word"
                                *ngIf="poll.isCryptographic && poll.votes_raw"
                                [ngStyle]="{
                                    color: poll.verified ? 'green' : poll.verified === false ? 'red' : 'yellow'
                                }"
                                iconTooltip="{{
                                    poll.verified
                                        ? 'Results verification success.'
                                        : poll.verified === false
                                        ? 'Result verification failed.'
                                        : ('Result verification pending.' | translate)
                                }}"
                                [icon]="
                                    poll.verified ? 'verified_user' : poll.verified === false ? 'gpp_bad' : 'shield'
                                "
                                (iconAction)="openVotingWarning()"
                            ></os-icon-container>
                            <span *ngIf="poll.isAnonymous || poll.isCryptographic === false">&nbsp;</span>
                            &middot;&nbsp;
                        </span>
                    </ng-container>
                    <span>
                        {{ poll.stateVerbose | translate }}
                    </span>
                </div>

                <!-- Menu -->
                <div class="poll-menu">
                    <!-- Buttons -->
                    <button
                        mat-icon-button
                        *osPerms="
                            [permission.projectorCanManage, permission.agendaItemCanManage];
                            or: canSeeCheckValidity
                        "
                        [matMenuTriggerFor]="pollItemMenu"
                        (click)="$event.stopPropagation()"
                    >
                        <mat-icon>more_horiz</mat-icon>
                    </button>
                </div>

                <!-- Change state button -->
                <div *osPerms="permission.agendaItemCanManage; and: !hideChangeState">
                    <button
                        mat-stroked-button
                        [ngClass]="pollStateActions[poll.state]?.css"
                        (click)="nextPollState()"
                        [disabled]="stateChangePendingObservable | async"
                    >
                        <mat-icon>{{ pollStateActions[poll.state]?.icon }}</mat-icon>
                        <span class="next-state-label">
                            <ng-container *ngIf="(stateChangePendingObservable | async) === false">
                                {{ poll.nextStateActionVerbose | translate }}
                            </ng-container>
                            <ng-container *ngIf="stateChangePendingObservable | async">
                                {{ 'In progress, please wait ...' | translate }}
                            </ng-container>
                        </span>
                        <span>
                            {{ poll.stateVerbose | translate }}
                        </span>
                    </button>
                </div>

                <!-- Enter Votes Hint -->
                <div *osPerms="permission.agendaItemCanManage; and: poll.isAnalog && !poll.stateHasVotes">
                    {{ 'Edit to enter votes.' | translate }}
                </div>
            </div>

            <!-- Chart / Table -->
            <div *ngIf="poll.stateHasVotes" class="poll-result-wrapper">
                <os-topic-poll-detail-content
                    *ngIf="!poll.isCryptographic || poll.verified"
                    [poll]="poll"
                ></os-topic-poll-detail-content>
                <os-poll-non-verification-content
                    *ngIf="poll.isCryptographic && !poll.verified"
                    [poll]="poll"
                ></os-poll-non-verification-content>
            </div>

            <!-- Poll progress bar -->
            <os-poll-progress *ngIf="poll && poll.isStarted" [poll]="poll"></os-poll-progress>

            <!-- The Vote -->
            <os-topic-poll-vote *ngIf="poll.canBeVotedFor()" [poll]="poll"></os-topic-poll-vote>

            <!-- Meta-Info -->
            <os-topic-poll-meta-info [poll]="poll" *ngIf="showMetaInfo"></os-topic-poll-meta-info>
        </div>
    </mat-card-content>
</mat-card>

<mat-menu #pollItemMenu="matMenu">
    <button *ngIf="canSeeCheckValidity" mat-menu-item (click)="openCheckValidityDialog()">
        <mat-icon>search</mat-icon>
        <span>{{ 'Check vote validity' | translate }}</span>
    </button>
    <div *osPerms="permission.agendaItemCanManage">
        <button mat-menu-item (click)="dialogOpened.emit()">
            <mat-icon>edit</mat-icon>
            <span>{{ 'Edit' | translate }}</span>
        </button>
    </div>
    <div *osPerms="permission.projectorCanManage">
        <os-projector-button
            [object]="poll"
            [menuItem]="true"
            *osPerms="permission.projectorCanManage"
        ></os-projector-button>
    </div>
    <button mat-menu-item (click)="downloadPdf()">
        <mat-icon>picture_as_pdf</mat-icon>
        <span>{{ 'Ballot papers' | translate }}</span>
    </button>
    <div *osPerms="permission.agendaItemCanManage">
        <mat-divider></mat-divider>

        <!-- Reset Button -->
        <button mat-menu-item (click)="resetState()">
            <mat-icon color="warn">replay</mat-icon>
            <span>{{ 'Reset state' | translate }}</span>
        </button>

        <!-- Delete button -->
        <button mat-menu-item class="red-warning-text" (click)="deletePoll()">
            <mat-icon>delete</mat-icon>
            <span>{{ 'Delete' | translate }}</span>
        </button>
    </div>
</mat-menu>
